<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programming Configuration Documentation</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 2em;
            background-color: #f4f7f9;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #fff;
            padding: 2.5em;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #e2e6e9;
            padding-bottom: 0.3em;
            margin-top: 1.5em;
        }
        h1 { font-size: 2.2em; }
        h2 { font-size: 1.8em; }
        h3 { font-size: 1.4em; }
        p { margin-bottom: 1em; }
        code {
            background-color: #eef2f5;
            padding: 0.1em 0.3em;
            border-radius: 4px;
            font-family: 'Consolas', 'Courier New', monospace;
            color: #c0392b;
        }
        pre {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 1em;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Consolas', 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        strong {
            color: #2c3e50;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5em;
        }
        th, td {
            padding: 1em;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f0f3f6;
            font-weight: bold;
            color: #555;
        }
        tr:nth-child(even) {
            background-color: #fafafa;
        }
        .note {
            background-color: #ecf0f1;
            padding: 1em;
            border-left: 4px solid #3498db;
            margin-top: 1em;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div class="container">

    <h1>Programming Configuration Documentation</h1>

    <p><strong>File Path:</strong> <code>/script/path/settings.json</code></p>

    <p><strong>Purpose:</strong> This JSON file defines the programming and operational rules for the broadcast system. It controls what content is played, at what times, on which channels, and under what conditions.</p>

    <p><strong>Target Audience:</strong> operators responsible for managing the TV station's content and schedule.</p>

    <hr>

    <h2>1. Top-Level Configuration</h2>
    <p>These are global settings that affect the entire operation of the station.</p>

    <table>
        <thead>
            <tr>
                <th>Field</th>
                <th>Type</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>version</code></td>
                <td>&lt;float&gt;</td>
                <td>The version number of the configuration file. The main script compares this number to ensure compatibility.</td>
            </tr>
            <tr>
                <td><code>name</code></td>
                <td>&lt;string&gt;</td>
                <td>The station's name, used to identify the script in the web front end.</td>
            </tr>
            <tr>
                <td><code>drive</code></td>
                <td><code>[&lt;string&gt;, &lt;array&gt;]</code></td>
                <td>A list of strings containing the root locations of your media content. The system automatically converts these to the <code>%D[index]%</code> keyword for use in file paths, where <code>index</code> is the position in this array (e.g., the first string is <code>%D[1]%</code>).</td>
            </tr>
            <tr>
                <td><code>insert_commercials</code></td>
                <td>&lt;boolean&gt;</td>
                <td>If set to <code>true</code>, the system will attempt to insert commercials into programming based on the <code>commercial_times</code> and <code>times</code> rules.</td>
            </tr>
            <tr>
                <td><code>commercials_per_break</code></td>
                <td><code>&lt;string&gt; | &lt;integer&gt;</code></td>
                <td>Controls the number of commercials to insert per break. Can be set to <code>'auto'</code> to allow the script to determine the number based on video lengths, or a <code>&lt;whole integer&gt;</code> to force a set number.</td>
            </tr>
            <tr>
                <td><code>commercials_fill_time_multiplier</code></td>
                <td>&lt;number&gt;</td>
                <td>A multiplier used in the logic to generate commercials to fill remaining time in a break. This helps to maintain a consistent schedule.</td>
            </tr>
            <tr>
                <td><code>commercials_offset_time</code></td>
                <td>&lt;integer&gt;</td>
                <td>A number of seconds to offset the calculated commercial fill time. A positive number adds time and is useful if shows are starting too early. A negative number subtracts time and is useful if shows are starting too late.</td>
            </tr>
            <tr>
                <td><code>time_test</code></td>
                <td><code>&lt;string&gt; | &lt;null&gt;</code></td>
                <td><strong>DEBUG FIELD:</strong> A string in Python date and time format (e.g., <code>"Jan 20 2024 04:58PM"</code>) that forces the script to program based on that specific time. Set to <code>null</code> for normal operation.</td>
            </tr>
            <tr>
                <td><code>debug</code></td>
                <td>&lt;boolean&gt;</td>
                <td>If <code>true</code>, the system outputs more detailed logging for troubleshooting in the terminal. Commercials only play the first 2 seconds before being skipped</td>
            </tr>
            <tr>
                <td><code>report_data</code></td>
                <td>&lt;boolean&gt;</td>
                <td>If set to <code>false</code>, no outgoing internet requests are permitted.</td>
            </tr>
            <tr>
                <td><code>player_settings</code></td>
                <td><code>[&lt;string&gt;, &lt;array&gt;]</code></td>
                <td>A list of arguments or commands to be sent to the media player (e.g., OMXplayer) upon playing a video.</td>
            </tr>
            <tr>
                <td><code>cache_path</code></td>
                <td>&lt;string&gt;</td>
                <td>The directory used for caching contents of directories.</td>
            </tr>
        </tbody>
    </table>

    <hr>

    <h2>2. Global Objects</h2>

    <h3>2.1 <code>channels</code> Object</h3>
    <p>Defines the different broadcast channels that the station can switch between.</p>
    <table>
        <thead>
            <tr>
                <th>Field</th>
                <th>Type</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>error</code></td>
                <td>&lt;string&gt;</td>
                <td>The name of the channel to switch to when an error occurs.</td>
            </tr>
            <tr>
                <td><code>names</code></td>
                <td><code>[&lt;string&gt;, &lt;array&gt;]</code></td>
                <td>A list of channel names. The index of the array corresponds to the channel number. The first index (<code>0</code>) is typically reserved or unused.</td>
            </tr>
            <tr>
                <td><code>file</code></td>
                <td>&lt;string&gt;</td>
                <td>The path to a file that stores the current channel name.</td>
            </tr>
        </tbody>
    </table>

    <h3>2.2 <code>web-ui</code> Object</h3>
    <p>Configuration for a potential web-based user interface.</p>
    <table>
        <thead>
            <tr>
                <th>Field</th>
                <th>Type</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>show_type_colors</code></td>
                <td>&lt;object&gt;</td>
                <td>A map of program tags to hex color codes for visual representation in the web UI.</td>
            </tr>
            <tr>
                <td><code>commmercial_type_colors</code></td>
                <td>&lt;object&gt;</td>
                <td>A map of commercial tags to hex color codes.</td>
            </tr>
            <tr>
                <td><code>tv_schedule_link</code></td>
                <td>&lt;string&gt;</td>
                <td>A URL to an external online schedule.</td>
            </tr>
            <tr>
                <td><code>database_info</code></td>
                <td>&lt;object&gt;</td>
                <td>Credentials and host information for the database used by the system.</td>
            </tr>
        </tbody>
    </table>

    <h3>2.3 <code>youtube-dl</code> Object</h3>
    <p>Settings for <code>yt-dlp</code>, used to download video content.</p>
    <table>
        <thead>
            <tr>
                <th>Field</th>
                <th>Type</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>command</code></td>
                <td>&lt;string&gt;</td>
                <td>The command to execute <code>yt-dlp</code>.</td>
            </tr>
            <tr>
                <td><code>update_command</code></td>
                <td>&lt;string&gt;</td>
                <td>The command to update <code>yt-dlp</code>.</td>
            </tr>
        </tbody>
    </table>

    <h3>2.4 <code>vars</code> Object</h3>
    <p>This object serves as a variable storage for reusable values, making the <code>times</code> and <code>commercial_times</code> sections cleaner and easier to read. Values can be referenced using the <code>"$ref/parent/key"</code> format. <strong>Note:</strong> The variable must be defined before it is referenced.</p>
    <p>A more detailed explanation of the <code>vars</code> object is available <a href="#details-references">below</a>.</p>

    <hr>

    <h2>3. Programming Rules (<code>times</code> Array)</h2>
    <p>This is the core of the programming logic. Each object in the array represents a rule for what to play. The rules are processed from top to bottom, and the first matching rule is executed.</p>

    <h3>3.1 Common Fields for a Rule Object</h3>
    <table>
        <thead>
            <tr>
                <th>Field</th>
                <th>Type</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>name</code></td>
                <td><code>[&lt;string&gt;, &lt;array&gt;]</code></td>
                <td>An array of paths to directories or video files. These paths can use special keywords like <code>%D[NUM]%</code>, where <code>NUM</code> is an index from the <code>drive</code> array.</td>
            </tr>
            <tr>
                <td><code>type</code></td>
                <td>&lt;string&gt;</td>
                <td>
                    Defines the playback behavior. The following types are available:
                    <ul>
                        <li><code>video</code>: Selects a random video from a single directory.</li>
                        <li><code>video-show</code>: Selects a random "show" from a directory of video files, balancing playback by total play count.</li>
                        <li><code>balanced-video</code>: Selects a random video from a directory, balancing by total play count. If multiple directories are supplied, one will be chosen based on a weighted play count.</li>
                        <li><code>ordered-show</code>: Selects a show from a directory and plays the next video file in ascending order based on previous playback.</li>
                        <li><code>ordered-video</code>: Selects a video from a directory and plays the next video file in ascending order based on previous playback from that directory.</li>
                        <li><code>commercial</code>: Selects a random video, identifying itself as a commercial for logging purposes.</li>
                    </ul>
                </td>
            </tr>
            <tr>
                <td><code>note</code></td>
                <td>&lt;string&gt;</td>
                <td>A human-readable note explaining the rule's purpose.</td>
            </tr>
            <tr>
                <td><code>channel</code></td>
                <td>&lt;string&gt;</td>
                <td>Specifies which channel underwhich the programming schedule will be triggered and played.</td>
            </tr>
            <tr>
                <td><code>set-tag</code></td>
                <td>&lt;string&gt;</td>
                <td>Sets the tag for the currently playing content. The <code>commercial_times</code> block uses this tag for targeting commercials. <strong>Note:</strong> A tag in a filename (e.g., <code>@cartoons@</code>) overrides any tag set by this field.</td>
            </tr>
            <tr>
                <td><code>log</code></td>
                <td>&lt;string&gt;</td>
                <td>Specifies logging behavior. <code>"latest-only"</code> means only the most recent playback of this rule will be logged.</td>
            </tr>
            <tr>
                <td><code>special</code></td>
                <td>&lt;string&gt;</td>
                <td>A tag used to identify specific special event programming (e.g., <code>"easter"</code>, <code>"xmas"</code>). Can be modified with <code>+/-</code> days (e.g., <code>"easter-10"</code>).<br>
					<br>
					Special words:
					<ul>
						<li>thanksgiving - returns True if it is currently Thanksgiving day in the USA</li>
						<li>xmas - returns True beginning the day after Thanksgiving up until Dec 25th</li>
						<li>easter - returns True if it is Easter day.</li>
						<li>mothers day - returns True if it is Mother's day.</li>
						<li>fathers day - returns True if it is Father's day.</li>
					</ul>
				</td>
            </tr>
            <tr>
                <td><code>prefer-folder</code></td>
                <td>&lt;boolean&gt;</td>
                <td>If <code>true</code>, the system will select a folder from the <code>name</code> list first, rather than combining all videos into a single list before selection.</td>
            </tr>
            <tr>
                <td><code>min-length</code> / <code>max-length</code></td>
                <td>&lt;integer&gt;</td>
                <td>The minimum and maximum duration (in seconds) for a video selected by this rule.</td>
            </tr>
            <tr>
                <td><code>chance</code></td>
                <td><code>&lt;float&gt; | &lt;string&gt;</code></td>
                <td>A value from <code>0.0</code> to <code>1.0</code> or a calculation string that determines the probability of this rule being selected. This allows for randomization. A full list of keywords for chance expressions can be found below.</td>
            </tr>
        </tbody>
    </table>

    <h3>3.2 Time and Date-Based Conditions</h3>
    <p>These conditions define when a rule is active. If multiple conditions are specified, they all must be true for the rule to be considered.</p>
    <table>
        <thead>
            <tr>
                <th>Field</th>
                <th>Type</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>between</code></td>
                <td><code>&lt;object&gt; | &lt;string&gt;</code></td>
                <td>Defines a specific time and/or date range. Can be a direct object or a <code>"$ref"</code> to a value in the <code>vars</code> section.
                    <ul>
                        <li><code>times</code>: <code>[[start_time, end_time]]</code> format (e.g., <code>["08:00AM", "10:00PM"]</code>).</li>
                        <li><code>dates</code>: <code>[[start_date, end_date]]</code> format (e.g., <code>["Mar 01", "Apr 01"]</code>).</li>
                    </ul>
                </td>
            </tr>
            <tr>
                <td><code>start</code> / <code>end</code></td>
                <td><code>[&lt;integer&gt;Hour, &lt;integer&gt;Minute] | &lt;string&gt;</code></td>
                <td>A specific start or end time in <code>[hour, minute]</code> format. Can also be a <code>"$ref"</code> to a value in <code>vars</code>.</td>
            </tr>
            <tr>
                <td><code>dayOfWeek</code></td>
                <td><code>[&lt;string&gt;, &lt;array&gt;]</code></td>
                <td>An array of days on which the content can be played (e.g., <code>"monday"</code>, <code>"sunday"</code>). The wildcard <code>all</code> is also supported.</td>
            </tr>
            <tr>
                <td><code>month</code></td>
                <td><code>[&lt;integer&gt;, &lt;array&gt;]</code></td>
                <td>An array of numbers that correspond to the months of the year (1-12). The wildcard <code>all</code> is also supported.</td>
            </tr>
        </tbody>
            <tr>
                <td><code>bumpers</code></td>
                <td>&lt;object&gt;</td>
                <td>
                    A dictionary with lists of paths to bumpers.
                    <ul>
                        <li><code>out</code>: Paths to bumpers played before a commercial break.</li>
                        <li><code>in</code>: Paths to bumpers played after a commercial break.</li>
                        <li><code>show-override</code>: A sub-object (<code>{"out": &lt;boolean&gt;, "in": &lt;boolean&gt;}</code>) that, if <code>true</code>, uses only the show-specific bumpers for that direction.</li>
                        <li><code>chance</code>: A sub-object (<code>{"out": &lt;string&gt;, "in": &lt;string&gt;}</code>) that determines the likelihood of a bumper being played, following the same rules as the main <code>chance</code> field.</li>
                    </ul>
                    <div class="note">
                        <strong>Notes:</strong>
                        <ul>
                            <li>If no bumpers are found in the specified directory, none will be played.</li>
                            <li>If multiple directories are specified, their contents are pooled.</li>
                            <li>Individual show directories can contain a <code>bumpers/in</code> or <code>bumpers/out</code> subdirectory, which will override the settings file.</li>
                            <li>Placing a file named <code>skip</code> in the show's <code>/bumpers</code> subdirectory will disable the bumpers defined in the settings file for that show.</li>
                        </ul>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>

    <hr>

    <h2>4. Commercial Rules (<code>commercial_times</code> Array)</h2>
    <p>This array defines the source of commercials. The system first finds an active rule in the <code>times</code> array, then finds a matching rule in <code>commercial_times</code> to determine which commercials to play.</p>

    <table>
        <thead>
            <tr>
                <th>Field</th>
                <th>Type</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>name</code></td>
                <td><code>[&lt;string&gt;, &lt;array&gt;]</code></td>
                <td>A list of folder paths for commercials. Supports the same keywords as the <code>times</code> array.</td>
            </tr>
            <tr>
                <td><code>note</code></td>
                <td>&lt;string&gt;</td>
                <td>A note explaining the purpose of the rule.</td>
            </tr>
            <tr>
                <td><code>prefer-folder</code></td>
                <td>&lt;boolean&gt;</td>
                <td>If <code>true</code>, the script selects from the supplied list of folders rather than combining all videos into a single list.</td>
            </tr>
            <tr>
                <td><code>weighted</code></td>
                <td><code>[&lt;integer&gt;, &lt;array&gt;]</code></td>
                <td>A list of weights corresponding to the <code>name</code> array. The higher the number, the more likely that folder will be selected. This is used in conjunction with <code>prefer-folder</code>.</td>
            </tr>
            <tr>
                <td><code>tag</code></td>
                <td>&lt;string&gt;</td>
                <td>The commercial rule will only be considered if the <code>set-tag</code> from the currently playing program matches this value.</td>
            </tr>
            <tr>
                <td><code>chance</code></td>
                <td><code>&lt;float&gt; | &lt;string&gt;</code></td>
                <td>A value from <code>0.0</code> to <code>1.0</code> or a calculation string to determine the probability of this rule being used. A full list of keywords for chance expressions can be found below.</td>
            </tr>
            <tr>
                <td><code>special</code></td>
                <td>&lt;string&gt;</td>
                <td>A tag used to match specific special event rules from the <code>times</code> array.</td>
            </tr>
            <tr>
                <td><code>between</code></td>
                <td><code>&lt;object&gt; | &lt;string&gt;</code></td>
                <td>Defines a specific time and/or date range. Same as in the <code>times</code> array.</td>
            </tr>
            <tr>
                <td><code>month</code></td>
                <td><code>[&lt;integer&gt;, &lt;array&gt;]</code></td>
                <td>A list of months (1-12) when the rule is active.</td>
            </tr>
            <tr>
                <td><code>channel</code></td>
                <td>&lt;string&gt;</td>
                <td>Specifies which broadcast channel this commercial rule applies to.</td>
            </tr>
        </tbody>
    </table>

    <hr>

    <h2 id="details-references">Details on Keywords and Expressions</h2>

    <h3>Special Keywords for Paths</h3>
    <ul>
        <li><code>%D[NUM]%</code>: Replaced by the drive path at index <code>NUM</code> from the <code>drive</code> array.</li>
    </ul>

    <h3>Special Keywords for Time/Date Expressions</h3>
    <p>These are used in <code>between</code>, <code>start</code>, and <code>end</code> fields when a string is used instead of an array.</p>
    <ul>
        <li><code>%HOUR%</code>: Current hour of the day in 12-hour format.</li>
        <li><code>%AMPM%</code>: Current AM/PM.</li>
        <li><code>%MIN%</code>: Current minute of the hour.</li>
        <li><code>%MONTH%</code>: Current month of the year in 3-letter format.</li>
        <li><code>%DAY%</code>: Current day of the month.</li>
        <li><code>%YEAR%</code>: Current year.</li>
    </ul>
    
    <h3>Special Keywords for <code>chance</code> Expressions</h3>
    <p>The <code>chance</code> field can be a mathematical equation that evaluates to a number between <code>0.0</code> and <code>1.0</code>. The following keywords are available:</p>
    <ul>
        <li><code>weekday</code>: Current day of the week (Monday = 0 / Sunday = 6).</li>
        <li><code>maxdays</code>: Total number of days in the current month.</li>
        <li><code>year</code>: Current year (e.g., 2025).</li>
        <li><code>day</code>: Current day of the month (1-31).</li>
        <li><code>month</code>: Current month of the year (1 = January, 12 = December).</li>
        <li><code>hour</code>: Current hour of the day (0-23).</li>
        <li><code>minute</code>: Current minute of the hour (0-59).</li>
        <li><code>sin</code>: Sine function.</li>
        <li><code>cos</code>: Cosine function.</li>
        <li><code>abs</code>: Absolute value.</li>
        <li><code>min</code>: Returns the smaller of two values.</li>
        <li><code>max</code>: Returns the larger of two values.</li>
        <li><code>round</code>: Rounds a number to the nearest whole number.</li>
        <li><code>floor</code>: Rounds a number down to the nearest whole number.</li>
        <li><code>ceil</code>: Rounds a number up to the nearest whole number.</li>
        <li><code>log</code>: Natural logarithm (base e).</li>
        <li><code>exp</code>: Exponential function (e^x).</li>
        <li><code>pi</code>: The mathematical constant π (≈ 3.14159).</li>
        <li><code>e</code>: The mathematical constant e (≈ 2.71828).</li>
        <li><code>scale</code>: Converts a whole number to a 0.0-1.0 scale by dividing by 100.</li>
        <li><code>clamp</code>: Restricts a value to the 0.0-1.0 range.</li>
    </ul>
    <p><strong>Example:</strong> <code>"clamp((4 - abs(hour - 8)) / 3.0 * (weekday in [5,6]) * .8)"</code>: This example of chance starts ramping up at 5 AM, peaks around 8 AM, and fades by 12 PM on Saturday and Sundays only.</p>

    <h3>Details on References</h3>
    <p>Settings can refer to variables defined within the <code>vars</code> object. This aids in creating reusable, configurable values. The format is <code>$ref/var_name/index/or/key</code>. The variable must be defined before it is referenced.</p>
    <pre><code>"vars": {
    "cartoons": { "am": { "start": [4, 0], "end": [10, 45] }, "pm": { "start": [15, 0], "end": [16, 45] } }
},

"times": [{
    "name": ["%D[1]%/cartoons/am"],
    "start": "$ref/cartoons/am/start",
    "end": "$ref/cartoons/am/end",
    "type": "video"
},
{
    "name": ["%D[1]%/cartoons/pm"],
    "start": "$ref/cartoons/pm/start",
    "end": "$ref/cartoons/pm/end",
    "type": "video"
}]</code></pre>

</div>

</body>
</html>